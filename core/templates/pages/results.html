{% extends 'layouts/base.html' %}


{% block stylesheets %}
<style>
  /* Fons amb color corporatiu de CSR */
  .bg-csr {
    background-color: #db8d34;
  }

  /* 
  =================================
  Contenidor d‚Äôinformaci√≥ detallada
  =================================
  */

  /* Contenidor general amb estil "neum√≤rfic" suau */
  .detail-container {
    background: linear-gradient(145deg, #f4f6f8, #e9edf2);
    border-radius: 1rem;
    padding: 2rem;
    box-shadow:
      inset 1px 1px 4px rgba(0, 0, 0, 0.05),
      inset -1px -1px 4px rgba(255, 255, 255, 0.6);
  }

  /* Targeta destacada amb gradient corporatiu i efecte 3D */
  .card-detail-info {
    background: linear-gradient(135deg, #db8d34 0%, #f3b66e 100%);
    color: #fff;
    border-radius: 1rem;
    padding: 1.5rem;

    box-shadow:
      5px 5px 12px rgba(0, 0, 0, 0.25),
      -3px -3px 6px rgba(255, 255, 255, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    transform-style: preserve-3d;
  }

  /* Efecte d‚Äôelevaci√≥ quan l‚Äôusuari fa hover */
  .card-detail-info:hover {
    transform: translateY(-4px) scale(1.03);
    box-shadow:
      10px 10px 20px rgba(0, 0, 0, 0.25),
      -4px -4px 8px rgba(255, 255, 255, 0.3);
  }

  /* 
  ===================================================
  Estils per a 'consells' segons color del sem√†for
  ===================================================
  */

  /* Color vermell intens: cr√≠tica greu */
  .advice-semaphore-red {
    background: #f8d7da;
    color: #842029;
    border-left: 5px solid #ea2121;
  }

  /* Vermell m√©s clar: av√≠s d‚Äôalerta moderada */
  .advice-semaphore-light-red {
    background: #fbeaea;
    color: #a94442;
    border-left: 5px solid #ea4242;
  }

  /* Verd clar: bones pr√†ctiques, encara amb marge de millora */
  .advice-semaphore-light-green {
    background: #e7f5ec;
    color: #2b593c;
    border-left: 5px solid #5dca5d;
  }

  /* Verd fosc: excel¬∑lent compliment o situaci√≥ √≤ptima */
  .advice-semaphore-green {
    background: #d1e7dd;
    color: #0f5132;
    border-left: 5px solid #26bd21;
  }

  
  /* Taronja: situaci√≥ de risc o millora important pendent */
  .advice-semaphore-orange {
    background: #fff3cd;
    color: #664d03;
    border-left: 5px solid #ffc107;
  }

  /* Groc clar: advert√®ncia suau, potencial de millora */
  .advice-semaphore-yellow {
    background: #fffbe6;
    color: #665c00;
    border-left: 5px solid #fff200c8;
  }

  /*
  ================================================================
  Classes auxiliars per colors de sem√†for purs (fons de puntuaci√≥)
  ================================================================ 
  */

  /* Fons vermell fort */
  .red {
    background: #ea2121;
  }

  /* Fons vermell clar */
  .light-red {
    background: #ea4242;
  }

  /* Fons taronja */
  .orange {
    background: #ffc107;
  }

  /* Fons groc intens */
  .yellow {
    background: #fff200c8;
  }

  /* Fons verd clar */
  .light-green {
    background: #5dca5d;
  }

  /* Fons verd intens */
  .green {
    background: #26bd21;
  }

</style>
{% endblock %}


{% block title %}
Resultats ‚Äì √çndex Miner de Responsabilitat Social Corporativa
{% endblock title %}

{% block content %}

<div id="results" class="container my-5">

  <!-- T√≠tol i resum del projecte -->
  <div class="bg-dark p-4 rounded shadow-lg mb-4 text-white">
    <h2 class="mb-1 fw-bold">üèóÔ∏è {{ project_data.project_name }}</h2>
    <p class="mb-0 fs-5 fw-semibold">Empresa: {{ project_data.company_name }} | Fase: {{ project_data.phase }}</p>
  </div>

  <!-- Ubicaci√≥ -->
  <div class="row mb-4">
    <div class="col-md-12">
      <!-- col-md-8 -->
      <div class="p-3 bg-dark rounded shadow-lg text-white">
        <h4 class="fw-bold">üåç Ubicaci√≥</h4>
        <p class="fs-5 fw-semibold">{{ project_data.mine_address }}</p>
      </div>
    </div>
  </div>

  <!-- Resultat global -->
  <div class="bg-dark rounded p-2 shadow-lg text-white text-center fs-4 mb-4">
    Puntuaci√≥ global: <strong>{{ ratings.rating_total }}</strong> ¬∑ Normalitzada: <strong>{{ ratings.nrating_total }}</strong>
  </div>

  <!-- Resultats detallats per dimensi√≥ -->
  <div class="row">
    <!-- Socioecon√≤mic -->
    <div class="col-md-12">
      {% include "partials/result_card.html" with total=ratings.socioeconomic.rating_total title="Dimensi√≥ Socioecon√≤mica" graph="results1" %}
    </div>

    <div class="col-md-12">
      {% include "partials/result_detail.html" with detail=ratings.socioeconomic.result see_more_button_id="detail_button_1" detail_info_id="detail_info_1" %}
    </div>


    <!-- Ambiental -->
    <div class="col-md-12 mt-4 mt-md-0">
      {% include "partials/result_card.html" with total=ratings.environment.rating_total title="Dimensi√≥ Ambiental" graph="results2" %}
    </div>

    <div class="col-md-12">
      {% include "partials/result_detail.html" with detail=ratings.environment.result see_more_button_id="detail_button_2" detail_info_id="detail_info_2" %}
    </div>

  </div>


  <div class="d-flex justify-content-between mt-4">
    <a href="{% url 'evaluator' %}?last=true&fingerprintId={{ fingerprint }}" class="btn btn-dark btn-lg shadow fw-bold">
      <i class="fas fa-arrow-left me-3"></i> Tornar
    </a>
  </div>


</div>


{% endblock content %}

{% block javascripts %}

<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>


{{ ratings|json_script:"ratings-data" }}

<script>
  // Executa el codi nom√©s quan la llibreria amCharts est√† llesta
  am5.ready(function() {
    // Obt√© les puntuacions globals del sistema (injectades al template)
    const ratings = JSON.parse($('#ratings-data').text());

    // Extracte de les puntuacions per dimensi√≥
    const SocieconomicResult = ratings["socioeconomic"]["result"];
    const EnvironmentResult = ratings["environment"]["result"];

    // Genera els gr√†fics per a cada dimensi√≥
    create_chart(SocieconomicResult, "results1");
    create_chart(EnvironmentResult, "results2");

    /**
     * Crea un gr√†fic de columnes amb amCharts 5 a partir d'una dimensi√≥
     * @param {Object} DimensionResult - Objecte amb els resultats de seccions d‚Äôuna dimensi√≥
     * @param {string} graphId - ID del div on s'ha de renderitzar el gr√†fic
    */
    function create_chart(DimensionResult, graphId) {
      const data = [];
      let ymax = 0;

      // Recorre les seccions de la dimensi√≥ i prepara les dades
      for (const result in DimensionResult) {
        const section = DimensionResult[result];
        const section_rating = section.rating_total;

        const fraction = section_rating.split("/");
        const value = parseInt(fraction[0]); // puntuaci√≥ obtinguda
        const yvalue = parseInt(fraction[1]);  // puntuaci√≥ m√†xima

        if (yvalue > ymax) {
          ymax = yvalue;
        }

        data.push({
          section: section.name,
          value: value,
          label: section.rating_total,
          color: "rgba(219, 141, 52, 0.8)" // color coorporatiu CSR 
        });
      }

      /**
       * Gr√†fic basat en l'exemple oficial d'amCharts:
       * https://www.amcharts.com/demos/column-with-rotated-series/
       * Adaptat i personalitzat amb est√®tica corporativa CSR.
       */


      // Inicialitza el gr√†fic
      var root = am5.Root.new(graphId);

      root.setThemes([
        am5themes_Animated.new(root)
      ]);

      var chart = root.container.children.push(am5xy.XYChart.new(root, {
        panX: true,
        panY: true,
        wheelX: "panX",
        wheelY: "zoomX",
        pinchZoomX: true,
        paddingLeft: 0,
        paddingRight: 1
      }));

      // Activa el cursor del gr√†fic
      var cursor = chart.set("cursor", am5xy.XYCursor.new(root, {}));
      cursor.lineY.set("visible", false);


      // Configura eix X amb noms de secci√≥
      var xRenderer = am5xy.AxisRendererX.new(root, {
        minGridDistance: 30,
        minorGridEnabled: true
      });

      xRenderer.labels.template.setAll({
        rotation: -10, 
        centerY: am5.p0, 
        centerX: am5.p50,
        paddingRight: 0,
        paddingTop: 0,
        fontSize: 12, 
        maxWidth: 90, 
      });

      var xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
        maxDeviation: 0.3,
        categoryField: "section",
        renderer: xRenderer,
        tooltip: null
      }));

      // Configura eix Y amb l√≠mit m√†xim calculat
      var yRenderer = am5xy.AxisRendererY.new(root, {
        strokeOpacity: 0.1
      });

      var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
        maxDeviation: 0.3,
        renderer: yRenderer,
        max: ymax
      }));

      // Tooltip personalitzat per mostrar la puntuaci√≥
      var tooltip = am5.Tooltip.new(root, {
        labelText: "Puntuaci√≥: {label}",
        getFillFromSprite: false,
        getLabelFillFromSprite: false
      });

      tooltip.get("background").setAll({
        fill: am5.color(0x000000),
        fillOpacity: 1,
        strokeOpacity: 0
      });

      tooltip.label.setAll({
        fill: am5.color(0xffffff),
        fontSize: 12
      });

      tooltip.label.adapters.add("fill", function() {
        return am5.color(0xffffff);
      });

      chart.zoomOutButton.set("forceHidden", true);  // Amaga el bot√≥ de zoom reset

      // Defineix la s√®rie de columnes
      var series = chart.series.push(am5xy.ColumnSeries.new(root, {
        name: "Puntuaci√≥",
        xAxis: xAxis,
        yAxis: yAxis,
        valueYField: "value",
        categoryXField: "section",
        tooltip: tooltip
      }));

      // Estil visual de les columnes
      series.columns.template.setAll({
        cornerRadiusTL: 5,
        cornerRadiusTR: 5,
        strokeOpacity: 0
      });

      // Assigna colors personalitzats per columna
      series.columns.template.adapters.add("fill", function(fill, target) {
        return target.dataItem.dataContext.color;
      });

      series.columns.template.adapters.add("stroke", function(stroke, target) {
        return target.dataItem.dataContext.color;
      });

      // Carrega les dades
      xAxis.data.setAll(data);
      series.data.setAll(data);

      // Apareixen amb animaci√≥
      series.appear(1000);
      chart.appear(1000, 100);

    }

  });

  // ================================
  // Bot√≥ per mostrar/ocultar detalls
  // ================================
  $(document).ready(function() {
    $("#detail_button_1, #detail_button_2").click(function() {
      let btn = $(this);
      let id = btn.attr("id");
      let btn_num = id.split("_")[2];
      let info_data = $("#detail_info_" + btn_num);

      if (info_data.is(":visible")) {
        info_data.hide();
        btn.text("Veure informaci√≥ detallada");
        btn.css("opacity", "1");
      } else {
        info_data.fadeIn(500);
        btn.text("Amagar informaci√≥ detallada");
        btn.css("opacity", "0.8");
      }
    });
  });

</script>
{% endblock javascripts %}
